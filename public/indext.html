<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SafeKaFernandino Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f8f9fa; }
    .navbar { background-color: #007bff; }
    .navbar-brand, .nav-link { color: #fff !important; }
    .card { border-radius: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table th { background-color: #007bff; color: white; }
    .summary-card { text-align: center; padding: 20px; }
    .summary-value { font-size: 1.8rem; font-weight: bold; color: #007bff; }
    .filter-container select, .filter-container input { display: inline-block; width: auto; margin-left: 5px; }
  </style>
</head>
<body>

  <!-- ðŸ”¹ NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">ðŸ›  SafeKaFernandino Admin</a>
      <div class="d-flex">
        <button class="btn btn-light btn-sm" onclick="loadData()">ðŸ”„ Refresh</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">

    <!-- ðŸ”¹ DASHBOARD SUMMARY -->
    <div class="row mb-4" id="summaryRow">
      <div class="col-md-3">
        <div class="card summary-card">
          <div>Total Incidents</div>
          <div id="totalIncidents" class="summary-value">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card summary-card">
          <div>Active Rescuers</div>
          <div id="activeRescuers" class="summary-value">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card summary-card">
          <div>Pending Cases</div>
          <div id="pendingCases" class="summary-value">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card summary-card">
          <div>Completed Cases</div>
          <div id="completedCases" class="summary-value">0</div>
        </div>
      </div>
    </div>

    <!-- ðŸ”¹ CHARTS -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-info text-white fw-bold">ðŸ“Š Incident Type Distribution</div>
          <div class="card-body"><canvas id="typeChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-warning text-dark fw-bold">ðŸ“ˆ Incident Status Overview</div>
          <div class="card-body"><canvas id="statusChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- ðŸ”¹ FILTERS + INCIDENT HISTORY -->
    <div class="card">
      <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
        ðŸ§¾ Incident History
        <div class="filter-container">
          <label>Status:</label>
          <select id="statusFilter" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="Pending">Pending</option>
            <option value="Accepted">Accepted</option>
            <option value="Completed">Completed</option>
          </select>

          <label>Date Range:</label>
          <select id="dateFilter" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="custom">Custom</option>
          </select>

          <input type="date" id="startDate" class="form-control form-control-sm d-none">
          <input type="date" id="endDate" class="form-control form-control-sm d-none">
        </div>
      </div>
      <div class="card-body">
        <table class="table table-striped" id="incidentTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Location</th>
              <th>Status</th>
              <th>UserId</th>
              <th>RescuerId</th>
              <th>CreatedAt</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const SERVER_URL = "http://localhost:3000";
    let allIncidents = [];

    async function loadRescuers() {
      try {
        const res = await fetch(`${SERVER_URL}/stations`);
        const data = await res.json();
        if (!data.success) throw new Error("Failed to fetch rescuers");

        const activeRescuers = data.stations.filter(r => r.IsActive == true || r.IsActive == 1);
        document.getElementById("activeRescuers").textContent = activeRescuers.length;
      } catch (err) {
        console.error(err);
      }
    }

    async function loadIncidents() {
      const table = document.querySelector("#incidentTable tbody");
      table.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";

      try {
        const res = await fetch(`${SERVER_URL}/incidents`);
        const data = await res.json();
        if (!data.success) throw new Error("Failed to fetch incidents");

        allIncidents = data.incidents;
        applyFilters();

      } catch (err) {
        console.error(err);
        table.innerHTML = `<tr><td colspan='7' class='text-danger'>Error loading incidents</td></tr>`;
      }
    }

    function applyFilters() {
      const status = document.getElementById("statusFilter").value;
      const dateRange = document.getElementById("dateFilter").value;
      const startDate = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
      const endDate = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;

      const filtered = allIncidents.filter(i => {
        let statusMatch = !status || i.Status === status;
        let dateMatch = true;

        const createdAt = new Date(i.CreatedAt);

        if (dateRange === "week") {
          const now = new Date();
          const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
          dateMatch = createdAt >= weekStart;
        } else if (dateRange === "month") {
          const now = new Date();
          dateMatch = createdAt.getMonth() === now.getMonth() && createdAt.getFullYear() === now.getFullYear();
        } else if (dateRange === "custom" && startDate && endDate) {
          dateMatch = createdAt >= startDate && createdAt <= endDate;
        }

        return statusMatch && dateMatch;
      });

      updateSummary(filtered);
      renderTable(filtered);
      renderCharts(filtered);
    }

    function updateSummary(incidents) {
      const total = incidents.length;
      const pending = incidents.filter(i => i.Status === "Pending").length;
      const completed = incidents.filter(i => i.Status === "Completed").length;
      document.getElementById("totalIncidents").textContent = total;
      document.getElementById("pendingCases").textContent = pending;
      document.getElementById("completedCases").textContent = completed;
    }

    function renderTable(incidents) {
      const table = document.querySelector("#incidentTable tbody");
      table.innerHTML = incidents.map(i => `
        <tr>
          <td>${i.Id}</td>
          <td>${i.Type}</td>
          <td>${i.Location}</td>
          <td>${i.Status}</td>
          <td>${i.UserId}</td>
          <td>${i.RescuerId || 'â€”'}</td>
          <td>${new Date(i.CreatedAt).toLocaleString()}</td>
        </tr>
      `).join('') || "<tr><td colspan='7'>No records found</td></tr>";
    }

    function renderCharts(incidents) {
      const typeCounts = {};
      const statusCounts = {};

      incidents.forEach(i => {
        typeCounts[i.Type] = (typeCounts[i.Type] || 0) + 1;
        statusCounts[i.Status] = (statusCounts[i.Status] || 0) + 1;
      });

      if (window.typeChartInstance) window.typeChartInstance.destroy();
      if (window.statusChartInstance) window.statusChartInstance.destroy();

      const ctxType = document.getElementById("typeChart");
      const ctxStatus = document.getElementById("statusChart");

      window.typeChartInstance = new Chart(ctxType, {
        type: 'pie',
        data: {
          labels: Object.keys(typeCounts),
          datasets: [{
            data: Object.values(typeCounts),
            backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8']
          }]
        }
      });

      window.statusChartInstance = new Chart(ctxStatus, {
        type: 'bar',
        data: {
          labels: Object.keys(statusCounts),
          datasets: [{
            label: 'Number of Incidents',
            data: Object.values(statusCounts),
            backgroundColor: ['#ffc107', '#007bff', '#28a745', '#6c757d']
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function loadData() {
      loadRescuers();
      loadIncidents();
    }

    // Filter listeners
    document.getElementById("statusFilter").addEventListener("change", applyFilters);
    document.getElementById("dateFilter").addEventListener("change", () => {
      const value = document.getElementById("dateFilter").value;
      const startInput = document.getElementById("startDate");
      const endInput = document.getElementById("endDate");
      if (value === "custom") {
        startInput.classList.remove("d-none");
        endInput.classList.remove("d-none");
      } else {
        startInput.classList.add("d-none");
        endInput.classList.add("d-none");
      }
      applyFilters();
    });
    document.getElementById("startDate").addEventListener("change", applyFilters);
    document.getElementById("endDate").addEventListener("change", applyFilters);

    setInterval(loadData, 10000);
    loadData();
  </script>

</body>
</html>
