<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Verify Accounts</title>
<style>
body { font-family: Arial; background: #f5f6fa; margin:0; padding:0;}
header { background:#2c3e50; padding:20px; color:white; text-align:center; font-size:24px; font-weight:bold;}
.container { max-width:1200px; margin:30px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
table { width:100%; border-collapse: collapse; margin-top:20px;}
table th, table td { padding:12px; border-bottom:1px solid #ccc; text-align:left;}
table th { background:#ecf0f1; }
.btn { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;}
.btn-view { background:#3498db; color:white; }
.btn-approve { background:#2ecc71; color:white; }
.btn-reject { background:#e74c3c; color:white; }
#previewModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center;}
#previewModal img { max-width:90%; max-height:90%; border-radius:10px; border:3px solid white;}
.back-btn { margin-bottom: 20px; background:#7f8c8d; color:white; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
.filter { margin-bottom: 15px; padding:6px 10px; font-size:16px; border-radius:5px; border:1px solid #ccc; }
</style>
</head>
<body>
<header>Admin Panel - Verify Accounts</header>
<div class="container">

<button class="btn back-btn" onclick="location.href='admin-landing.html'">‚Üê Back</button>

<h2>Pending Account Verifications</h2>

<label for="accountFilter">Filter by Type: </label>
<select id="accountFilter" class="filter" onchange="renderAccountsTable()">
  <option value="All">All</option>
  <option value="User">User</option>
  <option value="Rescuer">Rescuer</option>
</select>

<table id="accountsTable">
<thead>
<tr>
<th>ID</th>
<th>Type</th>
<th>Name</th>
<th>Email</th>
<th>Mobile</th>
<th>Valid ID</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="previewModal" onclick="this.style.display='none'">
<img id="previewImage" src="" />
</div>

<script>
const SERVER_URL = "https://graeme-unintegrated-richelle.ngrok-free.dev";
let allAccounts = [];

// Load pending users and rescuers
async function loadPendingAccounts() {
    try {
        const [usersRes, rescuersRes] = await Promise.all([
            fetch(`${SERVER_URL}/admin/pending-users`),
            fetch(`${SERVER_URL}/admin/pending-rescuers`)
        ]);

        const users = await usersRes.json();
        const rescuers = await rescuersRes.json();

        allAccounts = [
            ...users.map(u => ({ ...u, type: 'User', validIdPath: u.validId })),
            ...rescuers.map(r => ({ ...r, type: 'Rescuer', validIdPath: r.ValidIdPath }))
        ];

        renderAccountsTable();
    } catch(err) {
        console.error("Failed to load pending accounts:", err);
        alert("Failed to load pending accounts.");
    }
}

// Render table based on dropdown filter
function renderAccountsTable() {
    const filter = document.getElementById('accountFilter').value;
    const tbody = document.querySelector("#accountsTable tbody");
    tbody.innerHTML = "";

    const accounts = filter === "All" ? allAccounts : allAccounts.filter(a => a.type === filter);

    if (!accounts.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No pending accounts</td></tr>`;
        return;
    }

    accounts.forEach(account => {
        const fileName = account.validIdPath ? account.validIdPath.split(/[\\/]/).pop() : null;
        const idFileUrl = fileName ? `${SERVER_URL}/uploads/${account.type.toLowerCase()}s/${fileName}` : null;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${account.Id}</td>
            <td>${account.type}</td>
            <td>${account.Name}</td>
            <td>${account.Email}</td>
            <td>${account.Mobile || '-'}</td>
            <td>
              ${idFileUrl ? `<button class='btn btn-view' onclick='viewImage("${idFileUrl}")'>View</button>` : 'No ID'}
            </td>
            <td>
                <button class='btn btn-approve' onclick='approveAccount(${account.Id}, "${account.type}")'>Approve</button>
                <button class='btn btn-reject' onclick='rejectAccount(${account.Id}, "${account.type}")'>Reject</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Show modal with ID image
function viewImage(url) {
    const modal = document.getElementById("previewModal");
    const img = document.getElementById("previewImage");
    img.src = url;
    modal.style.display = "flex";
}

// Approve account
async function approveAccount(id, type) {
    if(!confirm(`Approve this ${type}'s ID?`)) return;
    const endpoint = type === 'User' ? 'approve' : `rescuers/approve`;
    try {
        await fetch(`${SERVER_URL}/admin/${endpoint}/${id}`, { method:'POST' });
        alert(`${type} Approved!`);
        await loadPendingAccounts();
    } catch(err){ console.error(err); alert(`Error approving ${type}.`); }
}

// Reject account
async function rejectAccount(id, type) {
    if(!confirm(`Reject this ${type}'s ID?`)) return;
    const endpoint = type === 'User' ? 'reject' : `rescuers/reject`;
    try {
        await fetch(`${SERVER_URL}/admin/${endpoint}/${id}`, { method:'POST' });
        alert(`${type} Rejected!`);
        await loadPendingAccounts();
    } catch(err){ console.error(err); alert(`Error rejecting ${type}.`); }
}

// Initial load
loadPendingAccounts();
</script>
</body>
</html>
